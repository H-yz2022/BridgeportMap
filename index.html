<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map</title>
    <!--
        This section loads all the required CSS files from your 'lib' directory.
        These paths are relative to your index.html file.
    -->
    <link rel="stylesheet" href="lib/leaflet.css" />
    <link rel="stylesheet" href="lib/leaflet.draw.css" />
    <link rel="stylesheet" href="lib/leaflet.markercluster.css" />
    <link rel="stylesheet" href="lib/leaflet.markercluster.default.css" />
    <link rel="stylesheet" href="lib/Control.MiniMap.min.css" />
    <link rel="stylesheet" href="lib/all.min.css" />

    <style>
        /* This CSS ensures the map takes up the full browser window */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <!-- This is the container for the map. Leaflet will render the map inside this div. -->
    <div id="map"></div>

    <!--
        This section loads all the required JavaScript libraries.
        The order is important: leaflet.js must be loaded first.
    -->
    <script src="lib/leaflet.js"></script>
    <script src="lib/leaflet.draw.js"></script>
    <script src="lib/leaflet.markercluster.js"></script>
    <script src="lib/Control.MiniMap.min.js"></script>
    <script src="lib/leaflet-ant-path.js"></script>

    <script>
        // Use a self-invoking anonymous function to avoid polluting the global scope.
        (async function() {
            // Initialize the map, setting its center location and initial zoom level, just like in your Python code.
            const map = L.map('map').setView([41.153380, -73.278997], 12);

            // Add the 'CartoDB positron' tile layer. This is the base map.
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // --- Function to create the tooltip HTML, similar to your GeoJsonTooltip in Python ---
            function createTooltipContent(properties) {
                const fields = ['TAZ_ID', 'TOWN', 'AREA', 'COUNTY', 'POP2019', 'HH2019', 'EMP2019', 'NRET2019'];
                let content = '';
                fields.forEach(field => {
                    const value = properties[field] !== undefined ? properties[field] : 'N/A';
                    content += `<b>${field}:</b> ${value}<br>`;
                });
                return content;
            }

            // --- Replicating the Population Density Colormap from Python ---
            // A simple JavaScript function to get a color based on the value.
            // This mimics your `branca.colormap.linear.YlGn_09.scale`.
            const colorScale = (value) => {
                const max = 7215; // Max value from your Python code's logic (taz.POP2019.max())
                if (value === 0) return "#faded1";
                if (value < max * 0.1) return '#ffffcc';
                if (value < max * 0.2) return '#d9f0a3';
                if (value < max * 0.3) return '#addd8e';
                if (value < max * 0.4) return '#78c679';
                if (value < max * 0.5) return '#41ab5d';
                if (value < max * 0.6) return '#238443';
                if (value < max * 0.7) return '#006837';
                if (value < max * 0.8) return '#004529';
                return '#004529';
            };

            // --- Load and Add the TAZ GeoJSON Layer ---
            try {
                // Fetch the GeoJSON data from your 'static' folder.
                const tazResponse = await fetch('static/TAZ.geojson');
                if (!tazResponse.ok) {
                    throw new Error(`Failed to fetch TAZ.geojson: ${tazResponse.statusText}`);
                }
                const tazData = await tazResponse.json();

                // Add the GeoJSON layer to the map with styling and tooltips.
                L.geoJSON(tazData, {
                    style: (feature) => ({
                        fillColor: colorScale(feature.properties.POP2019), // Apply the custom color scale
                        color: 'black',
                        weight: 0.5,
                        fillOpacity: 0.3,
                    }),
                    onEachFeature: (feature, layer) => {
                        // Highlight on hover
                        layer.on('mouseover', () => {
                            layer.setStyle({
                                color: 'blue',
                                weight: 4,
                            });
                        });
                        layer.on('mouseout', () => {
                            // Reset to original style when not hovered
                            L.geoJSON(feature, {
                                style: (f) => ({
                                    fillColor: colorScale(f.properties.POP2019),
                                    color: 'black',
                                    weight: 0.5,
                                    fillOpacity: 0.3,
                                })
                            }).setStyle(layer.feature, layer);
                        });
                        // Bind the tooltip
                        layer.bindTooltip(createTooltipContent(feature.properties));
                    }
                }).addTo(map);

            } catch (error) {
                console.error("Error loading TAZ GeoJSON:", error);
            }

            // --- Load and Add the Highway GeoJSON Layer ---
            try {
                // Fetch the GeoJSON data from your 'static' folder.
                const highwayResponse = await fetch('static/Highway.geojson');
                if (!highwayResponse.ok) {
                    throw new Error(`Failed to fetch Highway.geojson: ${highwayResponse.statusText}`);
                }
                const highwayData = await highwayResponse.json();

                // Add the GeoJSON layer to the map with styling and tooltips.
                L.geoJSON(highwayData, {
                    style: (feature) => ({
                        fillColor: 'black',
                        color: 'red',
                        weight: 6.0,
                        fillOpacity: 0.3,
                    }),
                    onEachFeature: (feature, layer) => {
                        // Highlight on hover
                        layer.on('mouseover', () => {
                            layer.setStyle({
                                color: 'blue',
                                weight: 4,
                            });
                        });
                        layer.on('mouseout', () => {
                            // Reset to original style
                            layer.setStyle({
                                fillColor: 'black',
                                color: 'red',
                                weight: 6.0,
                                fillOpacity: 0.3,
                            });
                        });
                        // Bind the tooltip
                        const highwayFields = ['TRAFFIC_VO', 'AADT', 'DIRECTION', 'SOV', 'HOV2', 'HOV3', 'FRT', 'LT', 'MT', 'HT'];
                        const highwayContent = highwayFields.map(field => `<b>${field}:</b> ${feature.properties[field] !== undefined ? feature.properties[field] : 'N/A'}`).join('<br>');
                        layer.bindTooltip(highwayContent);
                    }
                }).addTo(map);

            } catch (error) {
                console.error("Error loading Highway GeoJSON:", error);
            }

            // --- Add the MiniMap plugin to the map ---
            new L.Control.MiniMap(L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
            }), {
                toggleDisplay: true
            }).addTo(map);

        })(); // End of the self-invoking function
    </script>
</body>
</html>
